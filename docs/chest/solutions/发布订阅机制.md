### 前言

`2022.06.09` 

最近接了点外包，客户要求建立一个统一的事件发布推送机制。本来图简单，想弄个 MQ就结束了。

但是客户想做得更加完善，要求：

- 使用发布订阅机制，可以明确订阅方
- 可以保留消息推送记录和送达结果
- 可以保存消息处理结果

----

这里就不做代码实现了，其实也开发也简单。

<br>

### 实现思路

大致流程如下图所示：

![](https://shiva.oss-cn-hangzhou.aliyuncs.com/picture-master/202204/image-20220609210513569.png)

这里有一些通用的细节需要处理：

1. **同一个订阅地址重复订阅相同的事件，需要内部逻辑自动去重，确保不重复投递事件**
2. **事件接收地址由应用方负责按指定的规范提供，并且，事件接收接口不需要认证**
3. **不同的事件，有的需要做同步，有的只需要异步，需要做好区分**
4. **设计一些通用的，重复投递机制**

MMP，做个进阶版还挺麻烦的。

<br>

### 表结构设计

#### 事件类型

事件类型可以作为枚举，也可以做字典、建表

反正就是列举一些事件触发，需不需要多次推送，是同步还是异步



#### 第三方订阅信息表

- 主键
- 订阅地址
- 订阅类型（可以扩展为多个字段，例如优先级、是否重复推送、）
- 订阅时间
- 生效状态



#### 事件推送记录表

- 主键
- 推送时间
- 推送报文json
- 推送事件类型
- 是否同步事件（同步需要等待结果并保存，异步不需要）
- 第三方接受结果
- 第三方响应信息
- 第三方响应时间









<br>

### 基础对外文档

- <a href="https://shiva.oss-cn-hangzhou.aliyuncs.com/data/XXXX%E7%B3%BB%E7%BB%9F%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%9C%BA%E5%88%B6%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3.docx" target="_blank">简单文档模板</a>

